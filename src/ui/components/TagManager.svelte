<!--\n  TagManager Component\n  \n  Provides conversation tagging functionality with:\n  - Add/remove tags from conversations\n  - Visual tag display with colors\n  - Tag filtering and search\n  - Safe Mode integration\n  - Privacy-compliant local storage\n  \n  CRITICAL: Uses only --ix-* CSS variables for styling\n  CRITICAL: Integrates with Safe Mode for graceful degradation\n  CRITICAL: Uses enhanced-storage-manager for all data operations\n-->\n\n<script lang=\"ts\">\n  import { onMount, onDestroy } from 'svelte';\n  import { writable, type Writable } from 'svelte/store';\n  import { enhancedStorageManager } from '../../utils/storage/enhanced-storage-manager.js';\n  import { safeModeManager, isFeatureAffected } from '../../content/dom/safe-mode.js';\n  import { logger } from '../../utils/logger.js';\n  import type { Tag, ConversationMetadata } from '../../utils/types.js';\n\n  // Props\n  export let conversationId: string = '';\n  export let initialTags: Tag[] = [];\n  export let disabled: boolean = false;\n  export let compact: boolean = false;\n\n  // State\n  const tags: Writable<Tag[]> = writable(initialTags);\n  const isLoading: Writable<boolean> = writable(false);\n  const error: Writable<string | null> = writable(null);\n  const safeModeActive: Writable<boolean> = writable(false);\n  \n  let newTagName = '';\n  let showTagInput = false;\n  let tagInputElement: HTMLInputElement;\n  let availableColors = [\n    '#2563eb', // blue\n    '#dc2626', // red\n    '#16a34a', // green\n    '#ca8a04', // yellow\n    '#9333ea', // purple\n    '#c2410c', // orange\n    '#0891b2', // cyan\n    '#be185d'  // pink\n  ];\n  let selectedColor = availableColors[0];\n\n  // Unsubscribe functions\n  let unsubscribeSafeMode: (() => void) | null = null;\n\n  // Load tags on mount\n  onMount(async () => {\n    await loadTags();\n    \n    // Listen for Safe Mode changes\n    unsubscribeSafeMode = safeModeManager.onSafeModeChange((state) => {\n      safeModeActive.set(state.active && state.affectedFeatures.includes('conversation-tags'));\n    });\n    \n    // Initial Safe Mode check\n    const initialSafeModeState = safeModeManager.getSafeModeState();\n    safeModeActive.set(initialSafeModeState.active && initialSafeModeState.affectedFeatures.includes('conversation-tags'));\n  });\n\n  // Cleanup on destroy\n  onDestroy(() => {\n    if (unsubscribeSafeMode) {\n      unsubscribeSafeMode();\n    }\n  });\n\n  /**\n   * Load tags for current conversation\n   */\n  async function loadTags() {\n    if (!conversationId) return;\n    \n    try {\n      isLoading.set(true);\n      error.set(null);\n      \n      const loadedTags = await enhancedStorageManager.loadTags(conversationId);\n      tags.set(loadedTags);\n      \n      logger.info('[TagManager] Tags loaded successfully', { conversationId, count: loadedTags.length });\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to load tags';\n      error.set(errorMessage);\n      logger.error('[TagManager] Failed to load tags', err);\n    } finally {\n      isLoading.set(false);\n    }\n  }\n\n  /**\n   * Add a new tag to the conversation\n   */\n  async function addTag() {\n    if (!newTagName.trim() || !conversationId) return;\n    \n    // Check if tag already exists\n    const currentTags = $tags;\n    const existingTag = currentTags.find(tag => tag.name.toLowerCase() === newTagName.toLowerCase());\n    if (existingTag) {\n      error.set('Tag already exists');\n      return;\n    }\n    \n    try {\n      isLoading.set(true);\n      error.set(null);\n      \n      const newTag: Tag = {\n        id: crypto.randomUUID(),\n        name: newTagName.trim(),\n        color: selectedColor,\n        createdAt: new Date(),\n        conversationId\n      };\n      \n      await enhancedStorageManager.addTag(conversationId, newTag);\n      \n      // Update local state\n      tags.update(currentTags => [...currentTags, newTag]);\n      \n      // Reset input\n      newTagName = '';\n      showTagInput = false;\n      \n      // Track usage for analytics (with consent)\n      await enhancedStorageManager.incrementUsageStat('tags_added');\n      \n      logger.info('[TagManager] Tag added successfully', { conversationId, tagName: newTag.name });\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to add tag';\n      error.set(errorMessage);\n      logger.error('[TagManager] Failed to add tag', err);\n    } finally {\n      isLoading.set(false);\n    }\n  }\n\n  /**\n   * Remove a tag from the conversation\n   */\n  async function removeTag(tagId: string) {\n    if (!conversationId) return;\n    \n    const tagToRemove = $tags.find(tag => tag.id === tagId);\n    if (!tagToRemove) return;\n    \n    try {\n      isLoading.set(true);\n      error.set(null);\n      \n      await enhancedStorageManager.removeTag(conversationId, tagToRemove.name);\n      \n      // Update local state\n      tags.update(currentTags => currentTags.filter(tag => tag.id !== tagId));\n      \n      // Track usage for analytics (with consent)\n      await enhancedStorageManager.incrementUsageStat('tags_removed');\n      \n      logger.info('[TagManager] Tag removed successfully', { conversationId, tagName: tagToRemove.name });\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to remove tag';\n      error.set(errorMessage);\n      logger.error('[TagManager] Failed to remove tag', err);\n    } finally {\n      isLoading.set(false);\n    }\n  }\n\n  /**\n   * Show tag input with focus\n   */\n  function showAddTagInput() {\n    showTagInput = true;\n    // Focus input after DOM update\n    setTimeout(() => {\n      if (tagInputElement) {\n        tagInputElement.focus();\n      }\n    }, 0);\n  }\n\n  /**\n   * Hide tag input and reset state\n   */\n  function hideTagInput() {\n    showTagInput = false;\n    newTagName = '';\n    error.set(null);\n  }\n\n  /**\n   * Handle keyboard events in tag input\n   */\n  function handleTagInputKeydown(event: KeyboardEvent) {\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      addTag();\n    } else if (event.key === 'Escape') {\n      event.preventDefault();\n      hideTagInput();\n    }\n  }\n\n  /**\n   * Handle tag click for future filtering functionality\n   */\n  function handleTagClick(tag: Tag) {\n    // Future: Implement tag filtering\n    logger.info('[TagManager] Tag clicked', { tagName: tag.name });\n  }\n\n  /**\n   * Get accessible label for tag\n   */\n  function getTagLabel(tag: Tag): string {\n    return `Tag: ${tag.name}`;\n  }\n\n  /**\n   * Get accessible label for remove button\n   */\n  function getRemoveLabel(tag: Tag): string {\n    return `Remove tag: ${tag.name}`;\n  }\n</script>\n\n<!-- Main TagManager Container -->\n<div class=\"tag-manager\" class:compact class:disabled={disabled || $safeModeActive}>\n  <!-- Safe Mode Warning -->\n  {#if $safeModeActive}\n    <div class=\"safe-mode-notice\" role=\"alert\">\n      <span class=\"safe-mode-icon\">üõ°Ô∏è</span>\n      <span class=\"safe-mode-text\">Tagging temporarily disabled due to ChatGPT update</span>\n    </div>\n  {:else}\n    <!-- Error Display -->\n    {#if $error}\n      <div class=\"error-message\" role=\"alert\" aria-live=\"polite\">\n        <span class=\"error-icon\">‚ö†Ô∏è</span>\n        <span class=\"error-text\">{$error}</span>\n        <button \n          class=\"error-dismiss\"\n          on:click={() => error.set(null)}\n          aria-label=\"Dismiss error\"\n        >\n          √ó\n        </button>\n      </div>\n    {/if}\n\n    <!-- Tags Display -->\n    <div class=\"tags-container\" role=\"group\" aria-label=\"Conversation tags\">\n      {#each $tags as tag (tag.id)}\n        <div \n          class=\"tag\"\n          style=\"--tag-color: {tag.color || availableColors[0]}\"\n          role=\"button\"\n          tabindex=\"0\"\n          aria-label={getTagLabel(tag)}\n          on:click={() => handleTagClick(tag)}\n          on:keydown={(e) => e.key === 'Enter' && handleTagClick(tag)}\n        >\n          <span class=\"tag-name\">{tag.name}</span>\n          <button \n            class=\"tag-remove\"\n            on:click|stopPropagation={() => removeTag(tag.id)}\n            disabled={$isLoading}\n            aria-label={getRemoveLabel(tag)}\n          >\n            √ó\n          </button>\n        </div>\n      {/each}\n\n      <!-- Add Tag Button -->\n      {#if !showTagInput}\n        <button \n          class=\"add-tag-btn\"\n          on:click={showAddTagInput}\n          disabled={$isLoading || disabled}\n          aria-label=\"Add new tag\"\n        >\n          <span class=\"add-tag-icon\">+</span>\n          <span class=\"add-tag-text\">Tag</span>\n        </button>\n      {/if}\n    </div>\n\n    <!-- Tag Input -->\n    {#if showTagInput}\n      <div class=\"tag-input-container\">\n        <div class=\"tag-input-row\">\n          <input \n            bind:this={tagInputElement}\n            bind:value={newTagName}\n            class=\"tag-input\"\n            type=\"text\"\n            placeholder=\"Enter tag name...\"\n            maxlength=\"20\"\n            disabled={$isLoading}\n            on:keydown={handleTagInputKeydown}\n            aria-label=\"New tag name\"\n          />\n          \n          <!-- Color Picker -->\n          <div class=\"color-picker\" role=\"group\" aria-label=\"Tag color\">\n            {#each availableColors as color}\n              <button \n                class=\"color-option\"\n                class:selected={selectedColor === color}\n                style=\"--color: {color}\"\n                on:click={() => selectedColor = color}\n                disabled={$isLoading}\n                aria-label=\"Select color {color}\"\n              >\n              </button>\n            {/each}\n          </div>\n        </div>\n        \n        <div class=\"tag-input-actions\">\n          <button \n            class=\"tag-action-btn primary\"\n            on:click={addTag}\n            disabled={$isLoading || !newTagName.trim()}\n          >\n            {$isLoading ? 'Adding...' : 'Add'}\n          </button>\n          <button \n            class=\"tag-action-btn secondary\"\n            on:click={hideTagInput}\n            disabled={$isLoading}\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n    {/if}\n  {/if}\n</div>\n\n<style>\n  /* \n   * CRITICAL: All styles use --ix-* CSS variables\n   * These are mirrored from ChatGPT's computed styles\n   */\n  \n  .tag-manager {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    font-family: var(--ix-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);\n    font-size: var(--ix-font-size-sm, 0.875rem);\n    color: var(--ix-color-text-primary, #000);\n  }\n\n  .tag-manager.compact {\n    gap: var(--ix-spacing-xs, 0.25rem);\n  }\n\n  .tag-manager.disabled {\n    opacity: 0.6;\n    pointer-events: none;\n  }\n\n  /* Safe Mode Notice */\n  .safe-mode-notice {\n    display: flex;\n    align-items: center;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-sm, 0.5rem);\n    background: var(--ix-color-bg-warning, #fef3c7);\n    border: 1px solid var(--ix-color-border-warning, #fbbf24);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    font-size: var(--ix-font-size-xs, 0.75rem);\n    color: var(--ix-color-text-warning, #92400e);\n  }\n\n  .safe-mode-icon {\n    font-size: var(--ix-font-size-sm, 0.875rem);\n  }\n\n  /* Error Message */\n  .error-message {\n    display: flex;\n    align-items: center;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-sm, 0.5rem);\n    background: var(--ix-color-bg-error, #fef2f2);\n    border: 1px solid var(--ix-color-border-error, #fca5a5);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    font-size: var(--ix-font-size-xs, 0.75rem);\n    color: var(--ix-color-text-error, #dc2626);\n  }\n\n  .error-dismiss {\n    background: none;\n    border: none;\n    color: var(--ix-color-text-error, #dc2626);\n    cursor: pointer;\n    font-size: var(--ix-font-size-lg, 1.125rem);\n    line-height: 1;\n    margin-left: auto;\n    padding: 0;\n    width: 1.5rem;\n    height: 1.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .error-dismiss:hover {\n    background: var(--ix-color-bg-error-hover, #fecaca);\n    border-radius: var(--ix-border-radius, 0.375rem);\n  }\n\n  /* Tags Container */\n  .tags-container {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    align-items: center;\n  }\n\n  /* Individual Tag */\n  .tag {\n    display: flex;\n    align-items: center;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-sm, 0.5rem);\n    background: var(--tag-color, #2563eb);\n    color: white;\n    border-radius: var(--ix-border-radius, 0.375rem);\n    font-size: var(--ix-font-size-xs, 0.75rem);\n    font-weight: 500;\n    cursor: pointer;\n    transition: opacity 0.2s ease;\n    user-select: none;\n  }\n\n  .tag:hover {\n    opacity: 0.8;\n  }\n\n  .tag:focus {\n    outline: 2px solid var(--ix-color-focus, #3b82f6);\n    outline-offset: 2px;\n  }\n\n  .tag-name {\n    flex: 1;\n    min-width: 0;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  .tag-remove {\n    background: none;\n    border: none;\n    color: white;\n    cursor: pointer;\n    font-size: var(--ix-font-size-sm, 0.875rem);\n    line-height: 1;\n    padding: 0;\n    width: 1rem;\n    height: 1rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: var(--ix-border-radius, 0.375rem);\n    transition: background-color 0.2s ease;\n  }\n\n  .tag-remove:hover {\n    background: rgba(255, 255, 255, 0.2);\n  }\n\n  .tag-remove:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  /* Add Tag Button */\n  .add-tag-btn {\n    display: flex;\n    align-items: center;\n    gap: var(--ix-spacing-xs, 0.25rem);\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-sm, 0.5rem);\n    background: var(--ix-color-bg-secondary, #f3f4f6);\n    border: 1px dashed var(--ix-color-border-secondary, #d1d5db);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    color: var(--ix-color-text-secondary, #6b7280);\n    cursor: pointer;\n    font-size: var(--ix-font-size-xs, 0.75rem);\n    font-weight: 500;\n    transition: all 0.2s ease;\n  }\n\n  .add-tag-btn:hover {\n    background: var(--ix-color-bg-secondary-hover, #e5e7eb);\n    border-color: var(--ix-color-border-secondary-hover, #9ca3af);\n    color: var(--ix-color-text-primary, #000);\n  }\n\n  .add-tag-btn:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  .add-tag-icon {\n    font-size: var(--ix-font-size-sm, 0.875rem);\n    font-weight: bold;\n  }\n\n  /* Tag Input Container */\n  .tag-input-container {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ix-spacing-sm, 0.5rem);\n    padding: var(--ix-spacing-sm, 0.5rem);\n    background: var(--ix-color-bg-secondary, #f3f4f6);\n    border: 1px solid var(--ix-color-border-secondary, #d1d5db);\n    border-radius: var(--ix-border-radius, 0.375rem);\n  }\n\n  .tag-input-row {\n    display: flex;\n    align-items: center;\n    gap: var(--ix-spacing-sm, 0.5rem);\n  }\n\n  .tag-input {\n    flex: 1;\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-sm, 0.5rem);\n    border: 1px solid var(--ix-color-border-primary, #d1d5db);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    font-size: var(--ix-font-size-sm, 0.875rem);\n    font-family: var(--ix-font-family, inherit);\n    background: var(--ix-color-bg-primary, #fff);\n    color: var(--ix-color-text-primary, #000);\n  }\n\n  .tag-input:focus {\n    outline: 2px solid var(--ix-color-focus, #3b82f6);\n    outline-offset: 2px;\n    border-color: var(--ix-color-focus, #3b82f6);\n  }\n\n  .tag-input:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  /* Color Picker */\n  .color-picker {\n    display: flex;\n    gap: var(--ix-spacing-xs, 0.25rem);\n  }\n\n  .color-option {\n    width: 1.5rem;\n    height: 1.5rem;\n    border: 2px solid var(--ix-color-border-primary, #d1d5db);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    background: var(--color);\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .color-option.selected {\n    border-color: var(--ix-color-text-primary, #000);\n    transform: scale(1.1);\n  }\n\n  .color-option:hover {\n    transform: scale(1.05);\n  }\n\n  .color-option:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  /* Tag Actions */\n  .tag-input-actions {\n    display: flex;\n    gap: var(--ix-spacing-sm, 0.5rem);\n    justify-content: flex-end;\n  }\n\n  .tag-action-btn {\n    padding: var(--ix-spacing-xs, 0.25rem) var(--ix-spacing-md, 0.75rem);\n    border: 1px solid var(--ix-color-border-primary, #d1d5db);\n    border-radius: var(--ix-border-radius, 0.375rem);\n    font-size: var(--ix-font-size-sm, 0.875rem);\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .tag-action-btn.primary {\n    background: var(--ix-color-bg-primary-action, #3b82f6);\n    color: white;\n    border-color: var(--ix-color-bg-primary-action, #3b82f6);\n  }\n\n  .tag-action-btn.primary:hover:not(:disabled) {\n    background: var(--ix-color-bg-primary-action-hover, #2563eb);\n    border-color: var(--ix-color-bg-primary-action-hover, #2563eb);\n  }\n\n  .tag-action-btn.secondary {\n    background: var(--ix-color-bg-primary, #fff);\n    color: var(--ix-color-text-secondary, #6b7280);\n  }\n\n  .tag-action-btn.secondary:hover:not(:disabled) {\n    background: var(--ix-color-bg-secondary, #f3f4f6);\n    color: var(--ix-color-text-primary, #000);\n  }\n\n  .tag-action-btn:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n\n  /* Compact Mode Adjustments */\n  .tag-manager.compact .tag {\n    padding: 0.125rem 0.375rem;\n    font-size: var(--ix-font-size-xs, 0.75rem);\n  }\n\n  .tag-manager.compact .add-tag-btn {\n    padding: 0.125rem 0.375rem;\n    font-size: var(--ix-font-size-xs, 0.75rem);\n  }\n\n  .tag-manager.compact .tag-input-container {\n    padding: var(--ix-spacing-xs, 0.25rem);\n  }\n</style>